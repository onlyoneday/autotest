*** Settings ***
Library        Collections
Library        String
Library        OperatingSystem
Library        RequestsLibrary
Library        Collections
Library        XML
Library        json
Resource       ../BORSP_frontend/common/resources.txt

*** Variables ***
${domain}      shurenyun
${nodes IP}    172.16.1.8

*** Keywords ***
Login Sry
    [Arguments]       ${data}
    ${API_SERVER}=    Remove String     ${SERVER}      /ui
    Create Session    shurenyun         ${API_SERVER}
    ${resp}=          Post Request      shurenyun      /v1/login    data=${data}
    log               ${resp.text}
    [Return]          ${resp}

Create User Group
    [Arguments]      ${data}            ${headers}
    ${resp}=         Post Request       ${domain}    /v1/groups    data=${data}    headers=${headers}
    log              ${resp.text}
    [Return]         ${resp}

Create User
    [Arguments]       ${data}         ${headers}
    ${resp}=          Post Request    ${domain}     /v1/accounts      data=${data}     headers=${headers}
    log               ${resp.text}
    [Return]          ${resp}

Create Cluster
    [Arguments]       ${data}         ${headers}
    ${resp}=          Post Request    ${domain}    /v1/clusters    data=${data}    headers=${headers}
    log               ${resp.text}
    [Return]          ${resp}

Add Nodes
    [Arguments]       ${data}         ${headers}
    ${resp}=          Patch Request   ${domain}    /v1/nodes    data=${data}    headers=${headers}
    log               ${resp.text}
    [Return]          ${resp}

Add Registry Auth
    [Arguments]       ${data}         ${headers}
    ${resp}=          Post Request    ${domain}    /v1/external_registries    data=${data}    headers=${headers}
    log               ${resp.text}
    [Return]          ${resp}

Get App List
    [Arguments]    ${headers}
    Get User ID
    ${resp}=       Get Request    shurenyun    /v1/apps/?label=USER_ID==${user_id}    headers=${headers}
    log            ${resp.text}
    [Return]       ${resp}

About Me
    [Arguments]    ${headers}
    ${resp}=       Get Request    shurenyun    /v1/aboutme    headers=${headers}
    log            ${resp.text}
    [Return]       ${resp}

Delete App
    [Arguments]    ${headers}    ${id}
    ${resp}=       Delete Request    shurenyun    /v1/apps${id}    headers=${headers}
    log            ${resp.text}
    [Return]       ${resp}
#-------------------
Get User ID
    ${resp}=       About Me                ${adminheaders}
    Should Be Equal As Strings                 ${resp.status_code}      200
    ${user_id}=  Evaluate   "${resp.json()['data']['id']}"
    Set Global Variable           ${user_id}

Clear Test Apps
    ${resp}=       Get App List                ${adminheaders}
    Should Be Equal As Strings                 ${resp.status_code}      200

    # ${app_id}=  Evaluate  "${resp.json()['data']['apps'][0]['id']}"

    ${length}   Get Length  ${resp.json()['data']['apps']}
    : FOR    ${idx}    IN RANGE    ${length}
    \  Clear Test App  ${resp.json()['data']['apps'][${idx}]}


Clear Test App
    [Arguments]       ${app_id}
    ${resp}=       Delete App                ${adminheaders}    ${app_id}
    Should Be Equal As Strings                 ${resp.status_code}      200

Login Sry With Admin
    [Tags]    用户管理
    # ${data}=                      Set Variable              {"userName":"${MMJ USER}","password":"${MMJ PASSWD}"}
    ${data}=                      Set Variable              {"userName":"${ADMIN USER}","password":"${ADMIN PASSWD}"}
    ${resp}=                      Login Sry                 ${data}
    Should Be Equal As Strings    ${resp.status_code}       200
    ${token}=  Evaluate           '${resp.json()['data']}'
    ${adminheaders}=              Create Dictionary         Authorization=${token}
    Set Global Variable           ${adminheaders}

*** Test Cases ***
Testing Teardown
    Login Sry With Admin
    Run Keyword And Ignore Error       Clear Test Apps
    # Clear Test Cluster
    # Clear Test Users
    # Cleart Test Groups