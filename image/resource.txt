
*** Settings ***

Documentation   Cluster page test resources
Resource        ../app/resource.txt
Resource        ../common/resource.txt
Suite Setup     Open Browser And Login cchen
Test Setup      Go To Image Page
Suite Teardown  Close All Browsers

*** Variables ***
#---image page-------(IP)
${NEW PROJECT XPATH}           //a[@data-ui-sref="imageCreate"]
${FIRST PROJ DELETE XPATH}     //table[@ng-table="imageListCtrl.imageListTable"]/tbody/tr[1]/td[6]/button[3]
${DELETE CONFIRM IP XPATH}     //button[@data-ng-click="confirmCtrl.ok()"]

#---Create project page----
${PROJECT NAME XPATH}          //input[@name="projectName"]
${CODE URI XPATH}              //input[@name="codeUri"]
${IMAGE NAME XPATH}            //input[@name="image"]
${BRANCH XPATH}                //input[@name="branchName"]
${DESCRIPTION XPATH}           //textarea[@name="description"]
${START XPATH}                 //div[button="开始创建"]/button
${AUTO BUILD YES XPATH}        //div[@class="col-sm-2"]/label[@class="radio-inline"]
${AUTO BUILD NO XPATH}         //div[@class="col-sm-4"]/label[@class="radio-inline"]
${AUTO BUILD TIME XPATH}       //select[@data-required="imageCreateCtrl.form.active"]
${TRIGGER RULE TAG XPATH}      //div[@class="col-sm-2"]/label[@class="checkbox-inline"]
${TRIGGER RULE BRANCH XPATH}   //div[@class="col-sm-4"]/label[@class="checkbox-inline"]
${CODE 1}                https://github.com/CCissie/hello-world.git

#---- In Image info page-----(IIP)
#右上角的部署，构建，删除项目按钮
${DEPLOY LATEST XPATH}           //div[@class="btn-group-vertical pull-right"]//button[1]
${BUILD XPATH}                   //div[@class="btn-group-vertical pull-right"]//button[2]
${DELETE XPATH}                  //div[@class="btn-group-vertical pull-right"]//button[3]
${DELETE CONFIRM IIP XPATH}      //button[@data-ng-click="confirmCtrl.ok()"]

${BACK TO IMAGE LIST XPATH}  //li[a="镜像列表"]/a
${DESCRIPTION LINK XPATH}    //li[a="说明"]/a
${VERSION LINK XPATH}        //li[a="版本"]/a
${CONFIG LINK XPATH}         //li[a="配置"]/a
#build记录-------
${BUILD NUMBER XPATH}        //table[@class="table table-striped"]/tbody/tr/td[1]
${IMAGE XPATH}               //table[@class="table table-striped"]/tbody/tr/td[2]
${BUILD STATUS XPATH}        //table[@class="table table-striped"]/tbody/tr/td[3]
${BUILD BRANCH XPATH}        //table[@class="table table-striped"]/tbody/tr/td[4]
${COMMIT XPATH}              //table[@class="table table-striped"]/tbody/tr/td[5]
${BUILD TIME XPATH}          //table[@class="table table-striped"]/tbody/tr/td[6]
${OP XPATH}                  //table[@class="table table-striped"]/tbody/tr/td[7]

${COPY PULL COMMAND XPATH}   //tbody/tr/td/button[1]
${DEPLOY THIS XPATH}         //tbody/tr/td/button[2]
${LOG XPATH}                 //tbody/tr/td/button[3]


*** Keywords ***

Click New Project
    Click Link  ${NEW PROJECT XPATH}

Get Random Name
    ${name} =  Generate Random String    10
    [Return]  ${name}

Input Project Name  [Arguments]  ${name}
    Input Text  ${PROJECT NAME XPATH}  ${name}

Input Code Uri  [Arguments]  ${Code}
    Input Text  ${CODE URI XPATH}  ${Code}

Input Image name  [Arguments]  ${name}
    Input Text  ${IMAGE NAME XPATH}  ${name}

Input Branch  [Arguments]  ${bra}
    Input Text  ${BRANCH XPATH}  ${bra}

Input Description  [Arguments]  ${desc}
    Input Text  ${DESCRIPTION XPATH}  ${desc}

Select Auto Build Yes
    Click Element  ${AUTO BUILD YES XPATH}

Select Auto Build No
    Click Element  ${AUTO BUILD NO XPATH}

Select Auto Build Time 5
    Select From List By Index  ${AUTO BUILD TIME XPATH}  1

Select Auto Build Time 10
    Select From List By Index  ${AUTO BUILD TIME XPATH}  2

Select Auto Build Time 30
    Select From List By Index  ${AUTO BUILD TIME XPATH}  3

Choose Trigger Rule Tag
    Click Element  ${TRIGGER RULE TAG XPATH}

Choose Trigger Rule Branch
    Click Element  ${TRIGGER RULE BRANCH XPATH}

Start New Project
    Click Button  ${START XPATH}
    Sleep  5

Image Info Page Should Be Opened
    Wait Until Page Contains  查看镜像  5

# IIP -- Image info page

Click Build Button In IIP
    Click Button  ${BUILD XPATH}

Delete Project In IIP
    Click Button  ${DELETE XPATH}
    Sleep  1
    Click Button  ${DELETE CONFIRM IIP XPATH}
    Sleep  1

Verify Build Info Contain  [Arguments]  ${build_num}  ${image_name}  ${branch_name}  ${status}  ${time}
    ${get_commit} =  Get Text  ${COMMIT XPATH}
    ${image_uri} =  Evaluate  '${IMAGE SERVER}'+'${image_name}'+':'+'${branch_name}'+'_'+'${get_commit}'+'_'+'${build_num}'

    ${get_build_num} =  Get Text  ${BUILD NUMBER XPATH}
    ${get_image_uri} =  Get Text  ${IMAGE XPATH}
    ${get_branch} =  Get Text  ${BUILD BRANCH XPATH}
    ${get_status} =  Get Text  ${BUILD STATUS XPATH}
    ${get_build_time} =  Get Text  ${BUILD TIME XPATH}

    Should Be Equal As Numbers  ${get_build_num}  ${build_num}
    Should Be Equal As Strings  ${get_status}  ${status}
 #   Should Contain  ${get_image_uri}  ${image}ß
    Should Be Equal As Strings  ${get_branch}  ${branch_name}

Deploy Latest Build  [Arguments]  ${name}  ${cluster_index}
    Click Element  ${DEPLOY THIS XPATH}
    Input App Name  ${name}
    Select Cluster  ${cluster_index}
    Click Create App
    
Delete First Project
    Click Button  ${FIRST PROJ DELETE XPATH}
    Sleep  1
    Click Button  ${DELETE CONFIRM IP XPATH}
    Sleep  1

*** Test Cases ***
New A Project And Build And Deploy And Delete
    [Tags]  1
    #---new project----
    Click New Project
    ${project name} =  Generate Random String    10
    Input Project Name  ${project name}
    Input Code Uri  ${CODE 1}
    ${image name} =  Generate Random String    10    [LOWER]
    Input Image name  ${image name}
    Input Branch  master
    Input Description  测试
    Select Auto Build No
    Start New Project
    Image Info Page Should Be Opened

    #---build------
    Click Build Button In IIP
    Sleep  100
    ${get_time} =  Get Time
    Verify Build Info Contain  1  ${image name}  master  成功  ${get_time}

    #----deploy-----
    Deploy Latest Build   ${image name}  1
    Sleep  40
    Verity App Is Runing
    
    #-----delete deploy----
    Delete App In AIP

    #----back to image page----
    Go To Image Page
    Delete First Project


